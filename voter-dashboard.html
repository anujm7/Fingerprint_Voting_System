<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Voter Dashboard | Online Voting System</title>
<style>
  :root{
    --navy:#101a3a;
    --navy-2:#182447;
    --red:#e23b3b;
    --grey:#6b7280;
    --light:#f8fafc;
    --card:#ffffff;
    --shadow:0 10px 24px rgba(0,0,0,.15);
    --success:#10b981;
    --warning:#f59e0b;
    --danger:#ef4444;
  }
  
  *{margin:0;padding:0;box-sizing:border-box}
  body{
    font-family: "Segoe UI", Tahoma, sans-serif;
    color:#111827;background:var(--light);line-height:1.55;
  }

  /* Header */
  .voter-header{
    background:linear-gradient(135deg, var(--navy), var(--navy-2));
    color:#fff;padding:20px 28px;
    display:flex;justify-content:space-between;align-items:center;
    box-shadow:var(--shadow);
  }
  .voter-brand{display:flex;align-items:center;gap:15px}
  .voter-brand .logo{font-size:36px}
  .voter-brand .title{font-size:24px;font-weight:800}
  .voter-brand .sub{font-size:14px;opacity:.8;margin-top:4px}
  .voter-user{display:flex;align-items:center;gap:15px}
  .voter-avatar{
    width:50px;height:50px;border-radius:50%;background:var(--red);
    display:flex;align-items:center;justify-content:center;
    font-size:20px;font-weight:700;color:#fff;
  }
  .user-info h3{margin:0;font-size:16px}
  .user-info p{margin:0;font-size:12px;opacity:.8}
  .logout-btn{background:rgba(255,255,255,.2);color:#fff;border:none;padding:8px 16px;border-radius:20px;cursor:pointer;font-weight:600}

  /* Navigation */
  .voter-nav{
    background:#fff;border-bottom:1px solid #e5e7eb;
    padding:0 28px;display:flex;gap:30px;
  }
  .nav-item{
    padding:15px 0;border-bottom:3px solid transparent;
    cursor:pointer;font-weight:600;color:var(--grey);
    transition:all .2s ease;
  }
  .nav-item:hover, .nav-item.active{
    color:var(--navy);border-color:var(--red);
  }

  /* Main Content */
  .voter-main{max-width:1200px;margin:0 auto;padding:30px 20px}

  /* Profile Section */
  .profile-section{margin-bottom:30px}
  .profile-card{
    background:#fff;border-radius:12px;box-shadow:var(--shadow);
    padding:30px;display:flex;align-items:center;gap:25px;
  }
  .profile-avatar{
    width:80px;height:80px;border-radius:50%;background:var(--red);
    display:flex;align-items:center;justify-content:center;
    font-size:32px;font-weight:700;color:#fff;
  }
  .profile-info h2{margin:0 0 8px 0;font-size:24px;color:var(--navy)}
  .profile-info .voter-id{
    background:var(--light);padding:4px 12px;border-radius:20px;
    font-size:14px;font-weight:700;color:var(--navy);display:inline-block;margin-bottom:10px;
  }
  .profile-details{display:grid;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));gap:15px;margin-top:15px}
  .profile-detail{display:flex;align-items:center;gap:8px;font-size:14px}
  .profile-detail .icon{color:var(--grey)}

  /* Dashboard Grid */
  .dashboard-grid{display:grid;grid-template-columns:repeat(auto-fit, minmax(280px, 1fr));gap:20px;margin-bottom:30px}
  .dashboard-card{
    background:#fff;border-radius:12px;padding:24px;box-shadow:var(--shadow);
    position:relative;overflow:hidden;
  }
  .dashboard-card::before{
    content:'';position:absolute;top:0;left:0;right:0;height:4px;
  }
  .dashboard-card.elections::before{background:var(--red)}
  .dashboard-card.voting::before{background:var(--success)}
  .dashboard-card.history::before{background:var(--warning)}

  .card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
  .card-title{font-size:16px;font-weight:700;color:var(--navy)}
  .card-icon{font-size:24px;color:var(--grey)}
  .card-content{font-size:14px;color:var(--grey);line-height:1.6}
  .card-value{font-size:28px;font-weight:800;color:var(--navy);margin:10px 0}
  .card-link{color:var(--red);text-decoration:none;font-weight:600;font-size:14px}
  .card-link:hover{text-decoration:underline}

  /* Elections List */
  .elections-list{background:#fff;border-radius:12px;box-shadow:var(--shadow);overflow:hidden}
  .elections-header{
    background:var(--navy);color:#fff;padding:20px 24px;
    display:flex;justify-content:space-between;align-items:center;
  }
  .elections-title{font-size:18px;font-weight:700}
  .election-item{
    padding:20px 24px;border-bottom:1px solid #e5e7eb;
    display:flex;justify-content:space-between;align-items:center;
  }
  .election-item:last-child{border-bottom:none}
  .election-info h4{margin:0 0 4px 0;color:var(--navy);font-size:16px}
  .election-info p{margin:0;color:var(--grey);font-size:14px}
  .election-meta{text-align:right}
  .election-date{color:var(--grey);font-size:14px;margin-bottom:8px}
  .election-status{
    padding:4px 12px;border-radius:20px;font-size:12px;font-weight:600;
    text-transform:uppercase;
  }
  .status-upcoming{background:#dbeafe;color:#1e40af}
  .status-ongoing{background:#d1fae5;color:#065f46}
  .status-completed{background:#f3f4f6;color:#374151}
  .vote-btn{
    background:var(--red);color:#fff;border:none;padding:8px 16px;
    border-radius:6px;cursor:pointer;font-weight:600;font-size:14px;
    margin-top:8px;
  }
  .vote-btn:disabled{background:var(--grey);cursor:not-allowed}

  /* Voting History */
  .history-table{width:100%;border-collapse:collapse}
  .history-table th{
    background:var(--light);color:var(--navy);font-weight:700;
    padding:12px 16px;text-align:left;font-size:14px;
  }
  .history-table td{padding:12px 16px;border-bottom:1px solid #e5e7eb;font-size:14px}
  .history-table tr:hover{background:rgba(248,250,252,.5)}

  /* Loading and Empty States */
  .loading{text-align:center;padding:40px;color:var(--grey)}
  .loading::before{
    content:'‚è≥';font-size:32px;display:block;margin-bottom:10px;
    animation:spin 1s linear infinite;
  }
  .empty-state{text-align:center;padding:40px;color:var(--grey)}
  .empty-state::before{content:'üì≠';font-size:48px;display:block;margin-bottom:15px}

  @keyframes spin{to{transform:rotate(360deg)}}

  /* Modal for Profile Edit */
  .modal{
    display:none;position:fixed;top:0;left:0;width:100%;height:100%;
    background:rgba(0,0,0,.5);z-index:9999;align-items:center;justify-content:center;
  }
  .modal.show{display:flex}
  .modal-content{
    background:#fff;border-radius:12px;padding:24px;max-width:500px;width:90%;
    max-height:80vh;overflow-y:auto;
  }
  .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
  .modal-title{font-size:20px;font-weight:700;color:var(--navy)}
  .modal-close{background:none;border:none;font-size:24px;cursor:pointer;color:var(--grey)}

  .form-group{margin-bottom:20px}
  .form-label{display:block;margin-bottom:8px;font-weight:600;color:var(--navy)}
  .form-input{
    width:100%;padding:12px;border:2px solid #e5e7eb;border-radius:8px;
    font-size:14px;transition:border-color .2s ease;
  }
  .form-input:focus{outline:none;border-color:var(--red)}
  .btn{
    border:none;border-radius:8px;padding:10px 20px;font-weight:600;
    cursor:pointer;transition:all .2s ease;font-size:14px;
  }
  .btn-primary{background:var(--red);color:#fff}
  .btn-secondary{background:var(--light);color:var(--navy)}

  /* Responsive */
  @media (max-width: 768px) {
    .voter-header{flex-direction:column;gap:15px;text-align:center}
    .profile-card{flex-direction:column;text-align:center}
    .dashboard-grid{grid-template-columns:1fr}
    .voter-nav{flex-wrap:wrap;gap:20px}
  }
</style>
</head>
<body>

  <!-- Voter Header -->
  <header class="voter-header">
    <div class="voter-brand">
      <div class="logo">üó≥Ô∏è</div>
      <div>
        <div class="title">Voter Portal</div>
        <div class="sub">Your Voting Dashboard</div>
      </div>
    </div>
    <div class="voter-user">
      <div class="voter-avatar" id="voter-avatar">?</div>
      <div class="user-info">
        <h3 id="voter-name">Loading...</h3>
        <p id="voter-status">Verifying registration...</p>
      </div>
      <button class="logout-btn" onclick="refreshData()" style="margin-right: 10px;">üîÑ Refresh</button>
      <button class="logout-btn" onclick="logout()">Logout</button>
    </div>
  </header>

  <!-- Navigation -->
  <nav class="voter-nav">
    <div class="nav-item active" onclick="showSection('dashboard')">üè† Dashboard</div>
    <div class="nav-item" onclick="showSection('elections')">üó≥Ô∏è Elections</div>
    <div class="nav-item" onclick="showSection('history')">üìä Voting History</div>
    <div class="nav-item" onclick="showSection('profile')">üë§ Profile</div>
  </nav>

  <main class="voter-main">
    <!-- Dashboard Section -->
    <div id="dashboard-section" class="content-section">
      <div class="profile-section">
        <div class="profile-card">
          <div class="profile-avatar" id="profile-avatar">?</div>
          <div class="profile-info">
            <h2 id="profile-name">Loading...</h2>
            <div class="voter-id" id="profile-voter-id">VOTER ID: Loading...</div>
            <div class="profile-details" id="profile-details">
              <div class="profile-detail"><span class="icon">üìç</span> <span id="profile-location">Loading...</span></div>
              <div class="profile-detail"><span class="icon">üìÖ</span> <span id="profile-age">Age: Loading...</span></div>
              <div class="profile-detail"><span class="icon">üè¢</span> <span id="profile-station">Station: Loading...</span></div>
              <div class="profile-detail"><span class="icon">‚úÖ</span> <span id="profile-registered">Registered: Loading...</span></div>
            </div>
          </div>
        </div>
      </div>

      <div class="dashboard-grid">
        <div class="dashboard-card elections">
          <div class="card-header">
            <div class="card-title">Available Elections</div>
            <div class="card-icon">üó≥Ô∏è</div>
          </div>
          <div class="card-value" id="available-elections">0</div>
          <div class="card-content">Elections you can participate in</div>
          <a href="#" class="card-link" onclick="showSection('elections')">View Elections ‚Üí</a>
        </div>

        <div class="dashboard-card voting">
          <div class="card-header">
            <div class="card-title">Voting Status</div>
            <div class="card-icon">‚úÖ</div>
          </div>
          <div class="card-value" id="voting-status">Ready</div>
          <div class="card-content" id="voting-message">You are eligible to vote in upcoming elections</div>
        </div>

        <div class="dashboard-card history">
          <div class="card-header">
            <div class="card-title">Voting History</div>
            <div class="card-icon">üìä</div>
          </div>
          <div class="card-value" id="vote-count">0</div>
          <div class="card-content">Elections you have participated in</div>
          <a href="#" class="card-link" onclick="showSection('history')">View History ‚Üí</a>
        </div>
      </div>
    </div>

    <!-- Elections Section -->
    <div id="elections-section" class="content-section" style="display:none;">
      <div class="elections-list">
        <div class="elections-header">
          <div class="elections-title">Available Elections</div>
        </div>
        <div id="elections-loading" class="loading">Loading elections...</div>
        <div id="elections-content"></div>
        <div id="elections-empty" class="empty-state" style="display:none;">
          <div>No elections available at this time.</div>
        </div>
      </div>
    </div>

    <!-- History Section -->
    <div id="history-section" class="content-section" style="display:none;">
      <div class="elections-list">
        <div class="elections-header">
          <div class="elections-title">Your Voting History</div>
        </div>
        <div id="history-loading" class="loading">Loading history...</div>
        <table class="history-table" id="history-table" style="display:none;">
          <thead>
            <tr>
              <th>Election</th>
              <th>Date</th>
              <th>Status</th>
              <th>Polling Station</th>
            </tr>
          </thead>
          <tbody id="history-tbody">
          </tbody>
        </table>
        <div id="history-empty" class="empty-state" style="display:none;">
          <div>You haven't voted in any elections yet.</div>
        </div>
      </div>
    </div>

    <!-- Profile Section -->
    <div id="profile-section" class="content-section" style="display:none;">
      <div class="elections-list">
        <div class="elections-header">
          <div class="elections-title">My Profile</div>
          <button class="btn btn-secondary" onclick="editProfile()">‚úèÔ∏è Edit Profile</button>
        </div>
        <div style="padding:24px;">
          <div class="profile-details" id="detailed-profile">
            <!-- Profile details will be loaded here -->
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Edit Profile Modal -->
  <div id="profile-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Edit Profile</h2>
        <button class="modal-close" onclick="closeProfileModal()">&times;</button>
      </div>
      <form id="profile-form">
        <div class="form-group">
          <label class="form-label">First Name</label>
          <input type="text" class="form-input" id="edit-firstName" required>
        </div>
        <div class="form-group">
          <label class="form-label">Last Name</label>
          <input type="text" class="form-input" id="edit-lastName" required>
        </div>
        <div class="form-group">
          <label class="form-label">Phone Number</label>
          <input type="tel" class="form-input" id="edit-phone">
        </div>
        <div class="form-group">
          <label class="form-label">Address</label>
          <input type="text" class="form-input" id="edit-address" required>
        </div>
        <div style="display:flex;gap:10px;justify-content:flex-end;">
          <button type="button" class="btn btn-secondary" onclick="closeProfileModal()">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Changes</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Firebase Integration -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getDatabase, ref, get, set, child, onValue } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyBUq8kXNMY29rfqEf0APbnyDMf-fWTc7SU",
      authDomain: "fingerprint-voting-syste-d926c.firebaseapp.com",
      databaseURL: "https://fingerprint-voting-syste-d926c-default-rtdb.firebaseio.com",
      projectId: "fingerprint-voting-syste-d926c",
      storageBucket: "fingerprint-voting-syste-d926c.firebasestorage.app",
      messagingSenderId: "458706704567",
      appId: "1:458706704567:web:e1595ac2701de926219532",
      measurementId: "G-4SEHLRDTCY"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);

    // Make available globally
    window.database = database;
    window.firebaseRefs = { ref, get, set, child, onValue };
    
    // Initialize dashboard on page load
    window.addEventListener('load', () => {
      initializeDashboard();
    });
  </script>

  <script>
    let currentVoter = null;
    let currentSection = 'dashboard';

    // Initialize dashboard
    async function initializeDashboard() {
      try {
        // Get voter ID from URL parameter or localStorage
        const urlParams = new URLSearchParams(window.location.search);
        const voterId = urlParams.get('voterId') || localStorage.getItem('currentVoterId');
        
        if (!voterId) {
          alert('No voter ID found. Please register first.');
          window.location.href = 'newenroll.html';
          return;
        }

        // Load voter data
        await loadVoterData(voterId);
        await loadDashboardData();
        
      } catch (error) {
        console.error('Error initializing dashboard:', error);
        alert('Error loading dashboard. Please try again.');
      }
    }

    // Load voter data
    async function loadVoterData(voterId) {
      try {
        const votersRef = window.firebaseRefs.ref(window.database, 'voters');
        const snapshot = await window.firebaseRefs.get(votersRef);
        
        if (snapshot.exists()) {
          const voters = snapshot.val();
          
          // Find voter by voterId
          const voterEntry = Object.entries(voters).find(([id, voter]) => voter.voterId === voterId);
          
          if (voterEntry) {
            const [id, voter] = voterEntry;
            currentVoter = { id, ...voter };
            
            // Update UI with voter data
            updateVoterUI(voter);
          } else {
            throw new Error('Voter not found');
          }
        } else {
          throw new Error('No voters in database');
        }
      } catch (error) {
        console.error('Error loading voter:', error);
        alert('Voter not found. Please check your registration.');
        window.location.href = 'newenroll.html';
      }
    }

    // Update voter UI
    function updateVoterUI(voter) {
      const initials = `${voter.firstName?.[0] || ''}${voter.lastName?.[0] || ''}`.toUpperCase();
      
      // Header
      document.getElementById('voter-avatar').textContent = initials;
      document.getElementById('voter-name').textContent = `${voter.firstName} ${voter.lastName}`;
      document.getElementById('voter-status').textContent = `Status: ${voter.status}`;
      
      // Profile section
      document.getElementById('profile-avatar').textContent = initials;
      document.getElementById('profile-name').textContent = `${voter.firstName} ${voter.lastName}`;
      document.getElementById('profile-voter-id').textContent = `VOTER ID: ${voter.voterId}`;
      document.getElementById('profile-location').textContent = `${voter.city}, ${voter.state}`;
      document.getElementById('profile-age').textContent = `Age: ${voter.age}`;
      document.getElementById('profile-station').textContent = `Station: ${voter.assignedPollingStation || 'Not Assigned'}`;
      document.getElementById('profile-registered').textContent = `Registered: ${new Date(voter.registrationDate).toLocaleDateString()}`;
      
      // Detailed profile
      const detailedProfile = document.getElementById('detailed-profile');
      detailedProfile.innerHTML = `
        <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(250px, 1fr));gap:20px;">
          <div class="profile-detail"><strong>Full Name:</strong> ${voter.firstName} ${voter.lastName}</div>
          <div class="profile-detail"><strong>Date of Birth:</strong> ${voter.dob}</div>
          <div class="profile-detail"><strong>Age:</strong> ${voter.age}</div>
          <div class="profile-detail"><strong>Gender:</strong> ${voter.gender}</div>
          <div class="profile-detail"><strong>Address:</strong> ${voter.address}</div>
          <div class="profile-detail"><strong>City:</strong> ${voter.city}</div>
          <div class="profile-detail"><strong>State:</strong> ${voter.state}</div>
          <div class="profile-detail"><strong>ZIP Code:</strong> ${voter.zip}</div>
          <div class="profile-detail"><strong>Organization:</strong> ${voter.organization}</div>
          <div class="profile-detail"><strong>ID Type:</strong> ${voter.idProofType}</div>
          <div class="profile-detail"><strong>Registration Date:</strong> ${new Date(voter.registrationDate).toLocaleDateString()}</div>
          <div class="profile-detail"><strong>Status:</strong> <span class="status-badge status-${voter.status.toLowerCase()}">${voter.status}</span></div>
        </div>
      `;
    }

    // Load dashboard data
    async function loadDashboardData() {
      try {
        // Load elections
        const electionsRef = window.firebaseRefs.ref(window.database, 'elections');
        const electionsSnapshot = await window.firebaseRefs.get(electionsRef);
        
        if (electionsSnapshot.exists()) {
          const elections = electionsSnapshot.val();
          const upcomingElections = Object.values(elections).filter(e => e.status === 'upcoming');
          document.getElementById('available-elections').textContent = upcomingElections.length;
        }

        // Load voting history
        const votingHistory = currentVoter.votingHistory || {};
        const voteCount = Object.values(votingHistory).filter(v => v === 'voted').length;
        document.getElementById('vote-count').textContent = voteCount;

      } catch (error) {
        console.error('Error loading dashboard data:', error);
      }
    }

    // Show section
    function showSection(section) {
      // Hide all sections
      document.querySelectorAll('.content-section').forEach(s => s.style.display = 'none');
      
      // Show selected section
      document.getElementById(section + '-section').style.display = 'block';
      
      // Update nav active state
      document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
      event.target.classList.add('active');
      
      currentSection = section;
      
      // Load section data
      if (section === 'elections') loadElections();
      else if (section === 'history') loadVotingHistory();
    }

    // Load elections
    async function loadElections() {
      const loading = document.getElementById('elections-loading');
      const content = document.getElementById('elections-content');
      const empty = document.getElementById('elections-empty');
      
      loading.style.display = 'block';
      content.innerHTML = '';
      empty.style.display = 'none';
      
      try {
        const electionsRef = window.firebaseRefs.ref(window.database, 'elections');
        const snapshot = await window.firebaseRefs.get(electionsRef);
        
        if (snapshot.exists()) {
          const elections = snapshot.val();
          const electionList = Object.entries(elections).filter(([id, election]) => 
            election.status === 'upcoming' || election.status === 'ongoing'
          );
          
          if (electionList.length > 0) {
            electionList.forEach(([electionId, election]) => {
              const electionDiv = document.createElement('div');
              electionDiv.className = 'election-item';
              electionDiv.innerHTML = `
                <div class="election-info">
                  <h4>${election.title}</h4>
                  <p>${election.description}</p>
                </div>
                <div class="election-meta">
                  <div class="election-date">${new Date(election.startDate).toLocaleDateString()}</div>
                  <div class="election-status status-${election.status}">${election.status}</div>
                  ${election.status === 'ongoing' ? 
                    `<button class="vote-btn" onclick="vote('${electionId}')">Vote Now</button>` :
                    `<button class="vote-btn" disabled>Not Started</button>`
                  }
                </div>
              `;
              content.appendChild(electionDiv);
            });
          } else {
            empty.style.display = 'block';
          }
        } else {
          empty.style.display = 'block';
        }
        
        loading.style.display = 'none';
      } catch (error) {
        console.error('Error loading elections:', error);
        loading.innerHTML = '<div style="color:red;">Error loading elections</div>';
      }
    }

    // Load voting history
    async function loadVotingHistory() {
      const loading = document.getElementById('history-loading');
      const table = document.getElementById('history-table');
      const tbody = document.getElementById('history-tbody');
      const empty = document.getElementById('history-empty');
      
      loading.style.display = 'block';
      table.style.display = 'none';
      empty.style.display = 'none';
      
      try {
        const votingHistory = currentVoter.votingHistory || {};
        
        if (Object.keys(votingHistory).length > 0) {
          tbody.innerHTML = '';
          
          Object.entries(votingHistory).forEach(([electionId, status]) => {
            const row = document.createElement('tr');
            row.innerHTML = `
              <td>${electionId.replace('_', ' ').toUpperCase()}</td>
              <td>Election Date</td>
              <td><span class="status-badge status-${status === 'voted' ? 'completed' : 'pending'}">${status}</span></td>
              <td>${currentVoter.assignedPollingStation || 'N/A'}</td>
            `;
            tbody.appendChild(row);
          });
          
          table.style.display = 'table';
        } else {
          empty.style.display = 'block';
        }
        
        loading.style.display = 'none';
      } catch (error) {
        console.error('Error loading voting history:', error);
        loading.innerHTML = '<div style="color:red;">Error loading history</div>';
      }
    }

    // Edit profile
    function editProfile() {
      document.getElementById('edit-firstName').value = currentVoter.firstName;
      document.getElementById('edit-lastName').value = currentVoter.lastName;
      document.getElementById('edit-phone').value = currentVoter.phone || '';
      document.getElementById('edit-address').value = currentVoter.address;
      
      document.getElementById('profile-modal').classList.add('show');
    }

    function closeProfileModal() {
      document.getElementById('profile-modal').classList.remove('show');
    }

    // Handle profile form submission
    document.getElementById('profile-form').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      try {
        const updates = {
          firstName: document.getElementById('edit-firstName').value,
          lastName: document.getElementById('edit-lastName').value,
          phone: document.getElementById('edit-phone').value,
          address: document.getElementById('edit-address').value
        };
        
        const voterRef = window.firebaseRefs.ref(window.database, `voters/${currentVoter.id}`);
        await window.firebaseRefs.set(voterRef, {...currentVoter, ...updates});
        
        // Update current voter object
        Object.assign(currentVoter, updates);
        updateVoterUI(currentVoter);
        
        closeProfileModal();
        alert('Profile updated successfully!');
        
      } catch (error) {
        console.error('Error updating profile:', error);
        alert('Error updating profile. Please try again.');
      }
    });

    // Vote function
    function vote(electionId) {
      alert(`Voting in election: ${electionId}\n(This would redirect to voting interface)`);
    }

    // Refresh data function
    async function refreshData() {
      try {
        console.log('üîÑ Refreshing voter data...');
        
        // Show loading indicator
        document.getElementById('voter-name').textContent = 'Refreshing...';
        document.getElementById('voter-status').textContent = 'Updating data...';
        
        // Reload voter data
        await loadVoterData();
        
        // Reload current section
        if (currentSection === 'elections') {
          await loadElections();
        } else if (currentSection === 'history') {
          await loadVotingHistory();
        }
        
        console.log('‚úÖ Data refresh completed');
        
        // Show success indicator briefly
        const originalStatus = document.getElementById('voter-status').textContent;
        document.getElementById('voter-status').textContent = '‚úÖ Data updated!';
        document.getElementById('voter-status').style.color = '#10b981';
        
        setTimeout(() => {
          document.getElementById('voter-status').textContent = originalStatus;
          document.getElementById('voter-status').style.color = '';
        }, 2000);
        
      } catch (error) {
        console.error('Error refreshing data:', error);
        document.getElementById('voter-status').textContent = '‚ùå Refresh failed';
        document.getElementById('voter-status').style.color = '#ef4444';
        
        setTimeout(() => {
          document.getElementById('voter-status').textContent = 'Voter';
          document.getElementById('voter-status').style.color = '';
        }, 3000);
      }
    }

    // Setup real-time listeners for voter data
    function setupRealtimeListeners() {
      if (!currentVoter) return;
      
      // Listen for changes to this voter's data
      const voterRef = window.firebaseRefs.ref(window.database, `voters/${currentVoter.id}`);
      window.firebaseRefs.onValue(voterRef, (snapshot) => {
        if (snapshot.exists()) {
          const updatedVoter = snapshot.val();
          currentVoter = {...currentVoter, ...updatedVoter};
          updateVoterUI(currentVoter);
          console.log('üîÑ Voter data updated in real-time');
        }
      });

      // Listen for election changes
      const electionsRef = window.firebaseRefs.ref(window.database, 'elections');
      window.firebaseRefs.onValue(electionsRef, () => {
        if (currentSection === 'elections') {
          loadElections();
        }
        console.log('üîÑ Elections data updated');
      });
    }

    // Enhanced load voter data function
    const originalLoadVoterData = loadVoterData;
    loadVoterData = async function() {
      await originalLoadVoterData();
      // Setup real-time listeners after initial load
      setTimeout(() => {
        setupRealtimeListeners();
      }, 1000);
    };

    // Logout function
    function logout() {
      if (confirm('Are you sure you want to logout?')) {
        localStorage.removeItem('currentVoterId');
        window.location.href = 'main.html';
      }
    }

    // Make functions available globally
    window.showSection = showSection;
    window.refreshData = refreshData;
    window.editProfile = editProfile;
    window.closeProfileModal = closeProfileModal;
    window.vote = vote;
    window.logout = logout;
  </script>

</body>
</html>